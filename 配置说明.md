# 配置文件示例

以下是一个完整的 `wrangler.toml` 配置文件示例，其中包含了实际的值（请替换为您自己的值）：

```toml
name = "my-r2-proxy"
main = "index.js"
compatibility_date = "2023-07-01"
account_id = "1234567890abcdef1234567890abcdef"  # 替换为您的实际账户ID

[vars]
R2_BUCKET_NAME = "my-private-bucket"  # 替换为您的R2存储桶名称
PROXY_SECRET = "MySuperSecurePassword123!"  # 设置一个强密码
RATE_LIMIT_WINDOW = "900"  # 15分钟（以秒为单位）
MAX_REQUESTS_PER_WINDOW = "100"  # 每个时间窗口内的最大请求数

[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "my-private-bucket"  # 替换为您的R2存储桶名称

[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "1234567890abcdef1234567890abcdef"  # 替换为您的KV命名空间ID
preview_id = "abcdef1234567890abcdef1234567890"  # 替换为您的预览KV命名空间ID
```

## 配置说明

### 1. 基本配置
- `name`: Worker的名称，将成为URL的子域名部分
- `main`: 主入口文件路径
- `compatibility_date`: Workers运行时的兼容性日期
- `account_id`: 您的Cloudflare账户ID

### 2. 环境变量 ([vars]部分) - 通过网页部署时需要在Cloudflare控制台设置
- `R2_BUCKET_NAME`: 您的R2存储桶名称
- `PROXY_SECRET`: 访问受保护文件的密钥，应该使用强密码
- `RATE_LIMIT_WINDOW`: 速率限制时间窗口，单位为秒
- `MAX_REQUESTS_PER_WINDOW`: 每个时间窗口内允许的最大请求数

### 3. R2 存储桶配置 - 通过网页部署时需要在Cloudflare控制台设置
- `binding`: 在代码中引用R2存储桶的变量名（R2_BUCKET）
- `bucket_name`: 实际的R2存储桶名称

### 4. KV 命名空间配置 - 通过网页部署时需要在Cloudflare控制台设置
- `binding`: 在代码中引用KV命名空间的变量名（RATE_LIMIT_KV）
- `id`: 生产环境使用的KV命名空间ID
- `preview_id`: 预览/开发环境使用的KV命名空间ID

### 5. 通过 GitHub 部署的配置说明

当通过 GitHub 在 Cloudflare 网页中部署时，您需要：

#### 5.1 环境变量配置
在 Cloudflare 控制台的 Worker 设置中配置以下环境变量：
- `R2_BUCKET_NAME`: 您的 R2 存储桶名称
- `PROXY_SECRET`: 您设置的访问密钥
- `RATE_LIMIT_WINDOW`: 速率限制窗口（可选，默认为 900）
- `MAX_REQUESTS_PER_WINDOW`: 最大请求数（可选，默认为 100）

#### 5.2 服务绑定配置
在 Cloudflare 控制台中配置以下绑定：
- **R2 绑定**：
  - Variable name: `R2_BUCKET`
  - Service: 选择您创建的 R2 存储桶
- **KV 命名空间绑定**：
  - Variable name: `RATE_LIMIT_KV`
  - KV namespace: 选择您创建的 KV 命名空间

#### 5.3 构建配置
- 构建命令：`npm install`（网页部署时通常不需要显式部署命令）
- 构建环境：选择 `npm`

注意：通过 GitHub 部署时，`account_id`、`id` 和 `preview_id` 等敏感信息不需要存储在代码库中，而是在 Cloudflare 控制台的安全环境中配置，这提高了安全性。

## 如何获取这些值

### 获取账户ID
1. 登录 Cloudflare 控制面板
2. 点击"My Profile"（我的资料）
3. 在"Account"部分找到"Account ID"

### 创建并获取R2存储桶名称
1. 在Cloudflare控制面板中进入R2部分
2. 点击"Create bucket"
3. 输入存储桶名称并创建

### 创建并获取KV命名空间ID
1. 在Cloudflare控制面板中进入"Workers & Pages" > "KV"
2. 点击"Create a namespace"
3. 输入名称并创建
4. 复制生成的ID

## 安全建议

### 密钥设置
- 使用至少12个字符的强密码
- 包含大小写字母、数字和特殊字符
- 定期更换密钥
- 示例强密码：`MySecureKey2025!@#`

### 速率限制配置
- 对于低流量网站：`MAX_REQUESTS_PER_WINDOW = "50"`
- 对于中等流量网站：`MAX_REQUESTS_PER_WINDOW = "100"`
- 对于高流量网站：`MAX_REQUESTS_PER_WINDOW = "200"`

## 测试配置

在部署前，您可以先检查配置是否正确：

1. 确保所有 `your-` 开头的占位符都已替换
2. 验证账户ID、存储桶名称和KV ID格式正确
3. 确保密钥足够强且安全

### 验证步骤
```bash
# 检查wrangler是否正确安装
wrangler --version

# 检查是否已登录
wrangler whoami

# 验证配置（不实际部署）
wrangler deploy --dry-run
```

## 常见错误及解决方案

### 错误：账户ID无效
**解决方案：** 双重检查账户ID的格式，确保没有多余的空格或字符

### 错误：R2存储桶不存在
**解决方案：** 确认R2存储桶已创建，并且名称拼写正确

### 错误：KV命名空间ID无效
**解决方案：** 确认KV命名空间已创建，并且ID复制正确

### 错误：密钥过于简单
**解决方案：** 设置一个强密码，包含字母、数字和特殊字符的组合