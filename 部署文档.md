# Cloudflare R2 代理部署文档

本文档将指导您如何将 Cloudflare R2 代理项目部署到 Cloudflare Workers 上，即使是没有任何技术经验的用户也能轻松完成。

此代理支持多种文件类型：
- 图片：jpg, jpeg, png, gif, svg, webp, ico
- 文档：pdf, doc, docx, txt, html, css, js
- 视频：mp4, webm, ogg
- 音频：mp3, wav, flac, aac
- 归档：zip, csv
- 数据库：sqlite, db
- 可执行文件：exe, dll, lib
- 等等

## 第一步：准备工作

### 1. 注册 Cloudflare 账户
- 访问 [https://dash.cloudflare.com](https://dash.cloudflare.com)
- 点击 "Sign up" 注册一个免费账户
- 按照提示完成注册和验证过程

### 2. 创建 R2 存储桶
- 登录 Cloudflare 控制面板
- 在左侧菜单中找到 "R2" 并点击
- 点击 "Create bucket" 按钮
- 输入存储桶名称（例如：my-website-assets），然后点击 "Create Bucket"
- 记住您创建的存储桶名称，后面会用到

### 3. 获取账户 ID
- 在 Cloudflare 控制面板顶部，找到您的账户信息
- 点击 "Get your API token" 或查看账户详情
- 找到 "Account ID" 并复制保存，后面会用到

## 第二步：上传代码到 GitHub

### 1. 创建 GitHub 账户（如果还没有）
- 访问 [https://github.com](https://github.com)
- 注册一个免费账户

### 2. 创建新仓库
- 登录 GitHub 后，点击右上角的 "+"，选择 "New repository"
- 填写仓库名称（例如：cf-r2-proxy）
- 选择 "Public"（公开）
- 勾选 "Add a README file"
- 点击 "Create repository"

### 3. 上传项目文件
由于您已经创建了项目文件，现在需要将它们上传到 GitHub：

方法一：使用 GitHub 网页上传
- 进入您刚创建的仓库页面
- 点击 "Add file" → "Upload files"
- 将以下文件拖拽到页面上：
  - `package.json`
  - `wrangler.toml`
  - `src/index.js`
- 上传完成后，点击 "Commit changes" 按钮

## 第三步：部署到 Cloudflare Workers

### 1. 在 Cloudflare 中连接 GitHub
- 回到 Cloudflare 控制面板
- 点击左侧菜单中的 "Workers & Pages"
- 点击 "Create application" → "Connect to Git"
- 选择 "GitHub" 并按照提示授权 Cloudflare 访问您的 GitHub 账户
- 选择您刚刚创建的仓库（cf-r2-proxy）

### 2. 配置部署设置
当 Cloudflare 自动检测到您的项目时：

- **构建配置**：
  - 构建命令：`npm install && npx wrangler deploy`
  - 构建输出目录：留空
  - 构建环境：选择 "Webpack"

### 3. 配置 R2 绑定（重要）
部署完成后，您需要为 Worker 配置 R2 绑定：

1. 在 Worker 概述页面，点击 "Settings" 选项卡
2. 点击 "R2 Bindings" 部分
3. 点击 "Add binding"
4. 输入以下信息：
   - **Variable name**: `R2_BUCKET`
   - **Bucket name**: 您在第一步中创建的 R2 存储桶名称
5. 点击 "Save and deploy"

这样就完成了 R2 存储桶与 Worker 的绑定。

### 4. 完成部署
- 点击 "Deploy" 按钮
- 等待部署完成（通常需要几分钟）
- 部署成功后，您会看到一个类似 `your-project.your-subdomain.workers.dev` 的 URL

## 第四步：修改配置文件

部署完成后，您需要修改 `wrangler.toml` 文件以使用正确的账户 ID 和存储桶名称：

1. 在 GitHub 仓库中找到 `wrangler.toml` 文件
2. 点击编辑按钮（铅笔图标）
3. 将 `YOUR_ACCOUNT_ID` 替换为您的实际账户 ID
4. 将 `YOUR_BUCKET_NAME` 替换为您的 R2 存储桶名称
5. 提交更改

更新后的配置文件应如下所示：
```toml
name = "cf-r2-proxy"
main = "src/index.js"
compatibility_date = "2023-07-01"

[env.production]
account_id = "您的实际账户ID"
r2_buckets = [
    { binding = "R2_BUCKET", bucket_name = "您的R2存储桶名称" }
]
```

## 第五步：使用代理

部署完成后，您可以通过以下方式使用代理：

- 访问 `https://your-project.your-subdomain.workers.dev/` 来访问您存储桶中的文件
- 例如，要访问存储在 R2 中名为 `images/photo.jpg` 的文件，您需要访问：
  `https://your-project.your-subdomain.workers.dev/images/photo.jpg`

这样，所有对 R2 的访问都会通过您的 Worker 代理，从而防止直接访问 R2 造成流量费用。

## 常见问题

**Q: 部署失败怎么办？**
A: 检查环境变量是否正确配置，确保 API 令牌有足够的权限。

**Q: 无法访问 R2 中的文件怎么办？**
A: 确保文件路径正确，且 R2 存储桶中确实存在该文件。

**Q: 如何添加自定义域名？**
A: 在 Cloudflare Workers 设置中，您可以添加自定义域名来替代默认的 workers.dev 域名。

## 安全提示

- 此代理是公开访问的，不需要密钥
- 所有通过代理访问的文件都将对外公开
- 请确保只将需要公开的文件存储在 R2 存储桶中

## 高级配置

如果您需要更多控制（如访问限制、缓存规则等），可以修改 `src/index.js` 文件中的代码。当前实现在生产环境中对文件启用了 1 年的缓存，以提高性能并减少重复请求。

---

恭喜！您已成功部署 Cloudflare R2 代理，现在可以安全地提供 R2 存储的文件访问，而无需担心直接访问导致的流量费用。