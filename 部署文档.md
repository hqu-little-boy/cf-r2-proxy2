# Cloudflare R2 代理服务 - 详细部署文档

## 一、项目概述

Cloudflare R2 代理服务是一个基于 Cloudflare Worker 构建的应用程序，主要功能是为 R2 存储服务提供安全访问控制。它能够：

- 防止直接链接盗用
- 提供认证访问机制
- 实施速率限制以防止滥用
- 自动检测内容类型
- 提供安全的头部设置

## 二、部署前准备

### 2.1 注册 Cloudflare 账户

如果您还没有 Cloudflare 账户，请先注册：

1. 访问 [https://www.cloudflare.com](https://www.cloudflare.com)
2. 点击"Sign Up"注册账户
3. 完成邮箱验证

### 2.2 安装必要的工具

#### 安装 Node.js
- 访问 [https://nodejs.org](https://nodejs.org)
- 下载并安装 LTS 版本
- 验证安装：在命令行输入 `node -v` 和 `npm -v`

#### 安装 Wrangler CLI
打开命令行工具（Windows 用户使用命令提示符或 PowerShell，Mac/Linux 用户使用终端），执行以下命令：

```bash
npm install -g wrangler
```

验证安装：
```bash
wrangler --version
```

### 2.3 登录 Cloudflare

在命令行中执行：
```bash
wrangler login
```

浏览器会自动打开，让您授权 Wrangler 访问您的 Cloudflare 账户。请完成授权流程。

## 三、获取必要配置信息

### 3.1 获取 Cloudflare 账户 ID

1. 登录 Cloudflare 控制面板：[https://dash.cloudflare.com](https://dash.cloudflare.com)
2. 点击右上角的个人资料图标
3. 点击"My Profile"（我的资料）
4. 在"Account"（账户）部分，您可以看到"Account ID"（账户ID），复制这个ID

### 3.2 创建 R2 存储桶（Bucket）

1. 在 Cloudflare 控制面板中，点击左侧菜单的 "R2"
2. 点击"Create bucket"（创建存储桶）
3. 输入存储桶名称（例如：my-private-bucket）
4. 点击"Create"（创建）

### 3.3 创建 KV 命名空间

KV 命名空间用于存储速率限制数据：

1. 在 Cloudflare 控制面板中，点击左侧菜单的 "Workers & Pages"
2. 点击"KV"
3. 点击"Create a namespace"（创建命名空间）
4. 输入命名空间名称（例如：R2ProxyRateLimit）
5. 点击"Add"（添加）
6. 复制生成的 ID，这将在配置中使用

## 四、配置项目

### 4.1 下载项目代码

如果您还没有下载项目代码，请先获取：

```bash
git clone https://github.com/your-username/cf-r2-proxy.git
cd cf-r2-proxy
```

### 4.2 修改配置文件

找到项目根目录下的 `wrangler.toml` 文件，用文本编辑器打开并修改以下内容：

```toml
name = "r2-proxy"  # 您的 Worker 名称
main = "index.js"
compatibility_date = "2023-07-01"
account_id = "YOUR_ACCOUNT_ID"  # 替换为您的 Cloudflare 账户 ID

[vars]
R2_BUCKET_NAME = "your-r2-bucket-name"  # 替换为您的 R2 存储桶名称
PROXY_SECRET = "your-very-secure-secret-key"  # 设置一个强密码作为访问密钥
RATE_LIMIT_WINDOW = "900"  # 速率限制窗口（秒），默认 15 分钟
MAX_REQUESTS_PER_WINDOW = "100"  # 每个时间窗口内的最大请求数

[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "your-r2-bucket-name"  # 替换为您的 R2 存储桶名称

[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "YOUR_KV_NAMESPACE_ID"  # 替换为您的 KV 命名空间 ID
preview_id = "YOUR_PREVIEW_KV_NAMESPACE_ID"  # 替换为您的预览 KV 命名空间 ID
```

**重要配置说明：**

- `name`：Worker 的名称，必须是唯一的，将作为 URL 的子域名
- `account_id`：您在第 3.1 步获取的账户 ID
- `R2_BUCKET_NAME`：您在第 3.2 步创建的存储桶名称
- `PROXY_SECRET`：访问受保护文件所需的密钥，务必设置一个强密码
- `RATE_LIMIT_WINDOW`：速率限制的时间窗口（秒），默认 900 秒（15 分钟）
- `MAX_REQUESTS_PER_WINDOW`：在时间窗口内的最大请求数，默认 100 次
- `KV_NAMESPACE_ID`：您在第 3.3 步获取的命名空间 ID

### 4.3 验证配置

确保所有占位符（如 `your-...`）都已替换为实际值。

## 五、部署项目

### 5.1 命令行部署方式（可选）

#### 5.1.1 安装项目依赖

在项目目录中执行：
```bash
npm install
```

#### 5.1.2 部署到 Cloudflare

执行以下命令部署：
```bash
wrangler deploy
```

如果一切配置正确，您应该会看到类似以下的输出：
```
✨ Successfully deployed your script to https://r2-proxy.your-subdomain.workers.dev
```

记录下生成的 URL，这是您的代理服务地址。

### 5.2 GitHub 网页部署方式（推荐）

#### 5.2.1 准备 GitHub 仓库

1. 登录到 GitHub 账户
2. 创建一个新的公共或私有仓库（例如：`cf-r2-proxy`）
3. 上传项目文件到仓库：
   - 克隆仓库到本地
   - 将项目文件复制到仓库目录
   - 提交并推送代码：
   ```bash
   git add .
   git commit -m "Initial commit"
   git push origin main
   ```

#### 5.2.2 在 Cloudflare 网页中创建 Worker

1. 登录 Cloudflare 控制面板：[https://dash.cloudflare.com](https://dash.cloudflare.com)
2. 在左侧菜单中选择 "Workers & Pages"
3. 点击 "Create application" 按钮
4. 选择 "Workers" 选项
5. 点击 "Connect to Git" 按钮

#### 5.2.3 连接 GitHub 仓库

1. 在弹出的界面中点击 "GitHub" 连接您的 GitHub 账户
2. 授权 Cloudflare 访问您的 GitHub 账户
3. 选择您刚才创建的仓库（如 `cf-r2-proxy`）
4. 点击 "Begin Setup"

#### 5.2.4 配置部署设置

1. 在 "Settings" 页面中，为您的 Worker 命名（例如：`r2-proxy`）
2. 在 "Build configuration" 部分，确认以下设置：
   - 构建命令：`npm install && npm run deploy` 或者可以自定义
   - 构建输出目录：`（留空或根据需要填写）`
   - 构建环境：选择 `npm`
3. 在 "Environment variables" 部分添加环境变量：
   - `R2_BUCKET_NAME`: 您的 R2 存储桶名称
   - `PROXY_SECRET`: 您设置的访问密钥
   - `RATE_LIMIT_WINDOW`: 速率限制窗口（可选，默认为 900）
   - `MAX_REQUESTS_PER_WINDOW`: 最大请求数（可选，默认为 100）
   - `CLOUDFLARE_ACCOUNT_ID`: 您的 Cloudflare 账户 ID
   - `CLOUDFLARE_API_TOKEN`: 您的 Cloudflare API 令牌

#### 5.2.5 部署 Worker

1. 点击 "Save and Deploy" 按钮
2. 系统将自动从 GitHub 拉取代码并开始构建
3. 部署完成后，您将看到部署成功的消息
4. 记录下生成的 URL，这是您的代理服务地址（格式如：https://r2-proxy.your-subdomain.workers.dev）

#### 5.2.6 配置 R2 和 KV 绑定

通过网页界面配置 R2 和 KV 绑定：

1. 在 Worker 的 "Settings" 标签页中，找到 "R2 Bindings"
2. 点击 "Add binding"
3. 设置：
   - Variable name: `R2_BUCKET`
   - Service: 选择您的 R2 存储桶
4. 在 "KV Namespace Bindings" 部分添加绑定：
   - Variable name: `RATE_LIMIT_KV`
   - KV namespace: 选择您之前创建的命名空间
5. 点击 "Save" 并重新部署 Worker

#### 5.2.7 验证部署

1. 等待部署完成后，访问您的 Worker URL
2. 检查是否显示欢迎消息
3. 尝试访问存储在 R2 中的文件，验证是否正常工作

#### 5.2.8 自动部署

通过 GitHub 部署的优势：
- 每当您向 GitHub 仓库推送代码时，Worker 会自动重新部署
- 您可以使用不同的分支进行测试和生产部署
- 更好的版本控制和团队协作

## 六、使用说明

### 6.1 公开文件访问

格式：`https://YOUR_WORKER_URL/OBJECT_KEY`

示例：
- 如果您的 Worker URL 是 `https://r2-proxy.your-subdomain.workers.dev`
- 文件在 R2 中的键是 `public/image.jpg`
- 访问 URL：`https://r2-proxy.your-subdomain.workers.dev/public/image.jpg`

### 6.2 受保护文件访问

格式：`https://YOUR_WORKER_URL/protected/OBJECT_KEY?secret=YOUR_SECRET`

示例：
- 如果您的 Worker URL 是 `https://r2-proxy.your-subdomain.workers.dev`
- 文件在 R2 中的键是 `private/document.pdf`
- 您设置的密钥是 `mysecret123`
- 访问 URL：`https://r2-proxy.your-subdomain.workers.dev/protected/document.pdf?secret=mysecret123`

### 6.3 速率限制说明

- 默认配置：每 15 分钟最多 100 个请求
- 当达到限制时，会返回 HTTP 429 状态码
- 您可以在配置中调整限制值以满足需求

## 七、安全建议

1. **密钥安全**：
   - 使用强密码作为 `PROXY_SECRET`
   - 定期更换密钥
   - 避免在客户端代码中暴露密钥

2. **权限控制**：
   - 受保护文件将强制下载，防止内联渲染
   - 公开文件可以内联显示但带有安全头部

3. **监控**：
   - 定期检查 Worker 流量
   - 关注速率限制触发情况

## 八、故障排除

### 8.1 部署失败

常见原因及解决方案：
- 确认已登录 Cloudflare：`wrangler whoami`
- 检查 `wrangler.toml` 配置是否正确
- 确认账户 ID 和 KV 命名空间 ID 正确

### 8.2 无法访问文件

- 检查 R2 存储桶中是否存在该文件
- 确认文件键名拼写正确
- 验证密钥是否正确（对于受保护文件）

### 8.3 速率限制问题

- 检查 `RATE_LIMIT_WINDOW` 和 `MAX_REQUESTS_PER_WINDOW` 配置
- 确认是否需要调整速率限制参数

## 九、维护和更新

### 9.1 更新配置

修改 `wrangler.toml` 中的配置后，重新执行：
```bash
wrangler deploy
```

### 9.2 更新代码

修改 `index.js` 文件后，重新部署：
```bash
wrangler deploy
```

### 9.3 查看日志

查看 Worker 运行日志：
```bash
wrangler tail
```

## 十、高级功能

### 10.1 自定义内容类型

系统会根据文件扩展名自动设置内容类型，支持以下类型：
- 图片格式：jpg, jpeg, png, gif, svg, webp, ico
- 文档格式：pdf, doc, docx, txt, html, css, js
- 视频格式：mp4, webm, ogg
- 音频格式：mp3, wav, flac, aac
- 压缩格式：zip, csv
- 数据库文件：sqlite, db
- 可执行文件：exe, dll, lib

### 10.2 安全头部

系统会自动添加以下安全头部：
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Strict-Transport-Security`
- `Content-Security-Policy`

---

恭喜！您已成功部署 Cloudflare R2 代理服务。现在您可以安全地访问 R2 存储中的文件，并防止直接链接盗用。